<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.app.ggshop.v1.mapper.BoardMapper">

    <!-- 게시글 등록 -->
    <insert id="insertBoard" useGeneratedKeys="true" keyProperty="id">
        insert into ggshop.tbl_board (
            title,
            content,
            board_filter,
            board_status,
            board_member_id
        ) values (
                     #{title},
                     #{content},
                     #{boardFilter.value},
                     'active',
                     coalesce(#{boardMemberId}, (select min(id) from ggshop.tbl_member))
                 )
    </insert>
    <select id="findAll" resultType="com.app.ggshop.v1.dto.BoardDTO">
        select
            id,
            title,
            content,
            (
                select f.file_path
                from tbl_file f
                         join tbl_board_file bf on f.id = bf.id
                where bf.board_id = b.id
                order by f.id asc
                limit 1
            ) as representativeFilePath,
            (
                select f.file_name
                from tbl_file f
                         join tbl_board_file bf on f.id = bf.id
                where bf.board_id = b.id
                order by f.id asc
                limit 1
            ) as representativeFileName,
            case
                when board_filter = '구매' then 'BUY'
                when board_filter = '판매' then 'SELL'
                else 'ALL'
            end as boardFilter,
            case
                when board_status = 'active' then 'ACTIVE'
                else 'INACTIVE'
            end as boardStatus,
            board_member_id as boardMemberId,
            created_date as createdDate,
            updated_date as updatedDate
        from ggshop.tbl_board b
        order by id desc
    </select>

    <select id="selectAll" resultType="com.app.ggshop.v1.dto.BoardDTO">
        select
            id,
            title,
            content,
            (
                select f.file_path
                from tbl_file f
                         join tbl_board_file bf on f.id = bf.id
                where bf.board_id = b.id
                order by f.id asc
                limit 1
            ) as representativeFilePath,
            (
                select f.file_name
                from tbl_file f
                         join tbl_board_file bf on f.id = bf.id
                where bf.board_id = b.id
                order by f.id asc
                limit 1
            ) as representativeFileName,
            case
                when board_filter = '구매' then 'BUY'
                when board_filter = '판매' then 'SELL'
                else 'ALL'
            end as boardFilter,
            case
                when board_status = 'active' then 'ACTIVE'
                else 'INACTIVE'
            end as boardStatus,
            board_member_id as boardMemberId,
            created_date as createdDate,
            updated_date as updatedDate
        from ggshop.tbl_board b
        where board_status = 'active'
        <if test="filter != null and filter != ''">
            <choose>
                <when test="filter == 'buyer'">
                    and board_filter = '구매'
                </when>
                <when test="filter == 'seller'">
                    and board_filter = '판매'
                </when>
            </choose>
        </if>
        <if test="keyword != null and keyword != ''">
            and (
                title like concat('%', #{keyword}, '%')
                or content like concat('%', #{keyword}, '%')
            )
        </if>
        order by id desc
        limit #{criteria.offset}, #{criteria.count}
    </select>

    <select id="selectTotal" resultType="int">
        select count(*)
        from ggshop.tbl_board
        where board_status = 'active'
        <if test="filter != null and filter != ''">
            <choose>
                <when test="filter == 'buyer'">
                    and board_filter = '구매'
                </when>
                <when test="filter == 'seller'">
                    and board_filter = '판매'
                </when>
            </choose>
        </if>
        <if test="keyword != null and keyword != ''">
            and (
                title like concat('%', #{keyword}, '%')
                or content like concat('%', #{keyword}, '%')
            )
        </if>
    </select>


    <select id="selectById" resultType="com.app.ggshop.v1.dto.BoardDTO">
        select
            id,
            title,
            content,
            (
                select f.file_path
                from tbl_file f
                         join tbl_board_file bf on f.id = bf.id
                where bf.board_id = b.id
                order by f.id asc
                limit 1
            ) as representativeFilePath,
            (
                select f.file_name
                from tbl_file f
                         join tbl_board_file bf on f.id = bf.id
                where bf.board_id = b.id
                order by f.id asc
                limit 1
            ) as representativeFileName,
            case
                when board_filter = '구매' then 'BUY'
                when board_filter = '판매' then 'SELL'
                else 'ALL'
            end as boardFilter,
            case
                when board_status = 'active' then 'ACTIVE'
                else 'INACTIVE'
            end as boardStatus,
            board_member_id as boardMemberId,
            created_date as createdDate,
            updated_date as updatedDate
        from ggshop.tbl_board b
        where id = #{id}
    </select>


    <update id="update">
        update ggshop.tbl_board
        set
            title = #{title},
            content = #{content},
            updated_date = current_timestamp
        where id = #{id}
    </update>


    <delete id="delete">
        delete from ggshop.tbl_board
        where id = #{id}
    </delete>

</mapper>
